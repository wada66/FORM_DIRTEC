<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Processo (Estilizado)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --border-color: #ced4da;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: #333;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
        }

        h2 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #555;
            transition: var(--transition);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .checkbox-inline {
            display: inline-block;
            margin-right: 25px;
            margin-top: 15px;
        }

        .checkbox-inline label {
            display: inline-block;
            margin-top: 0;
            font-weight: 400;
        }

        .campo-condicional { 
            margin-left: 0;
            display: none; 
            padding-left: 20px;
            border-left: 2px solid #e0e0e0;
            margin-top: 20px;
        }

        .campo-condicional label {
            margin-top: 0;
        }

        hr {
            border: 0;
            border-top: 1px solid #e0e0e0;
            margin: 30px 0;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 40px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
        }

        button[type="submit"]:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        button[type="reset"] {
            background-color: var(--secondary-color);
            color: white;
        }

        button[type="reset"]:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
        }

        .download-pdf-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background-color: #e9f2fa;
            border-radius: 8px;
        }

        .download-pdf-section h3 {
            color: #333;
            margin-bottom: 10px;
        }

        a.btn-download {
            display: inline-block;
            background-color: var(--success-color);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        a.btn-download:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Formulário de Processo</h1>
    <form method="POST" action="{{ url_for('inserir') }}">

        <h2>Informações Principais</h2>
        <label>Protocolo: <input type="text" name="protocolo" required></label>
        <label>Observações: <input type="text" name="observacoes"></label>
        <label>Número da Pasta: <input type="text" name="numero_pasta"></label>

        <label>Solicitação do Requerente:
            <select name="solicitacao_requerente" id= "solicitacao_requerente" required>
                <option value="">--Selecione--</option>
                {% for tipo_solicitacao_resposta in solicitacao_resposta %}
                    <option value="{{ tipo_solicitacao_resposta }}">{{ tipo_solicitacao_resposta }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Resposta do Departamento:
            <select name="resposta_departamento" id= "resposta_departamento" required>
                <option value="">--Selecione--</option>
                {% for tipo_solicitacao_resposta in solicitacao_resposta %}
                    <option value="{{ tipo_solicitacao_resposta }}">{{ tipo_solicitacao_resposta }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Tramitação:
             <select name="tramitacao" id= "tramitacao" required>
                <option value="">--Selecione--</option>
                {% for tipo_tramitacao in tramitacao %}
                    <option value="{{ tipo_tramitacao }}">{{ tipo_tramitacao }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Responsável pela Análise:
            <select name="responsavel_analise_cpf" required>
                <option value="">--Selecione--</option>
                {% for cpf, nome, setor in tecnico %}
                    <option value="{{ cpf }}">{{ nome }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Tipologia:
            <select name="tipologia" id= "tipologia" required>
                <option value="">--Selecione--</option>
                {% for nome_tipologia in tipologia %}
                    <option value="{{ nome_tipologia }}">{{ nome_tipologia }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Município:
            <select name="municipio" id="municipio" required>
                <option value="">--Selecione--</option>
                {% for nome_municipio in municipio %}
                    <option value="{{ nome_municipio }}">{{ nome_municipio }}</option>
                {% endfor %}
            </select>
        </label>

        <div class="campo-condicional" id="zona-urbana-container">
            <label>Zona Urbana:
                <select name="zona_urbana" id="zona-urbana"><option value="">--Selecione--</option></select>
            </label>
        </div>

        <div class="campo-condicional" id="macrozona-container">
            <label>Macrozona Municipal:
                <select name="macrozona_municipal" id="macrozona_municipal"><option value="">--Selecione--</option></select>
            </label>
        </div>

        <label>Situação da Localização:
            <select name="situacao_localizacao" id="situacao_localizacao" required>
                <option value="">--Selecione--</option>
                {% for opcao in situacoes_localizacao %}
                    <option value="{{ opcao }}">{{ opcao }}</option>
                {% endfor %}
            </select>
        </label>

        <div class="campo-condicional" id="localizacao-detalhes">
            <label>Responsável pela Localização:
                <select name="responsavel_localizacao_cpf">
                    <option value="">--Selecione--</option>
                    {% for cpf_tecnico, nome_tecnico, setor_tecnico in tecnico %}
                        <option value="{{ cpf_tecnico }}">{{ nome_tecnico }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Início da Localização: <input type="date" name="inicio_localizacao"></label>
            <label>Fim da Localização: <input type="date" name="fim_localizacao"></label>
        </div>

        <hr>

        <h2>Detalhes do Projeto</h2>
        <label>Nome ou loteamento do condomínio a ser aprovado:
            <input type="text" name="nome_ou_loteamento_do_condominio_a_ser_aprovado">
        </label>

        <div class="checkbox-inline">
            <label><input type="checkbox" name="interesse_social" value="SIM"> Interesse Social</label>
        </div>
        <div class="checkbox-inline">
            <label><input type="checkbox" name="lei_inclui_perimetro_urbano" value="SIM"> Lei inclui perímetro urbano</label>
        </div>

        <hr>

        <h2>Informações do Requerente</h2>
        <label>Nome do Requerente: <input type="text" name="nome_requerente" required></label>

        <label>Tipo de Requerente:
            <select name="tipo_de_requerente" id="tipo_de_requerente" required>
                <option value="">--Selecione--</option>
                <option value="PESSOA FÍSICA">Pessoa Física</option>
                <option value="PESSOA JURÍDICA">Pessoa Jurídica</option>
            </select>
        </label>

        <div class="campo-condicional" id="cpf-container">
            <label>CPF:
                <input type="text" name="cpf_requerente" id="cpf_requerente" placeholder="Digite o CPF" maxlength="14">
            </label>
        </div>

        <div class="campo-condicional" id="cnpj-container">
            <label>CNPJ:
                <input type="text" name="cnpj_requerente" id="cnpj_requerente" placeholder="Digite o CNPJ" maxlength="18">
            </label>
        </div>
        <label>Nome do Proprietário: <input type="text" name="nome_proprietario"></label>
        <label>CPF/CNPJ do Proprietário: <input type="text" name="cpf_cnpj_proprietario" maxlength="14"></label>
        <label>Matrícula do Imóvel: <input type="text" name="matricula_imovel"></label>

        <hr>

        <h2>Áreas Condicionais</h2>

        <div>
        <label>
            Possui APA?
            <input type="checkbox" id="possui-apa" class="trigger-condicional" data-target="#apa-container">
        </label>
        </div>

        <div class="campo-condicional" id="apa-container">
        <label>Selecione a APA:
             <select name="apa" id="apa">
                 <option value="">--Selecione--</option>
                 {% for opcao in enums.apa %}
                     <option value="{{ opcao }}">{{ opcao }}</option>
                 {% endfor %}
             </select>
        </label>
        </div>

        <div class="campo-condicional" id="zona-apa-container">
        <label>Zona da APA:
            <select id="zona-apa" name="zona_apa">
            <option value="">--Selecione--</option>
            </select>
        </label>
        </div>


        <div>
        <label>
            Possui UTP?
            <input type="checkbox" id="possui-utp" class="trigger-condicional" data-target="#utp-container">
        </label>
        </div>

        <div class="campo-condicional" id="utp-container">
        <label>Selecione a UTP:
             <select name="utp" id="utp">
                 <option value="">--Selecione--</option>
                 {% for opcao in enums.utp %}
                     <option value="{{ opcao }}">{{ opcao }}</option>
                 {% endfor %}
             </select>
        </label>
        </div>

        <div class="campo-condicional" id="zona-utp-container">
        <label>Zona da UTP:
            <select id="zona-utp" name="zona_utp">
            <option value="">--Selecione--</option>
            </select>
        </label>
        </div>

        <div>
            <label>
                Possui Manancial?
                <input type="checkbox" id="possui-manancial" class="trigger-condicional" data-target="#tipo-manancial-container"
                        {% if existing and existing.possui_manancial %}checked{% endif %}>
            </label>
        </div>

        <div class="campo-condicional" id="tipo-manancial-container">
            <label>Tipo de Manancial:
                <select name="tipo_manancial" id="tipo-manancial">
                    <option value="">--Selecione--</option>
                    {% for opcao in enums.manancial %}
                        <option value="{{ opcao }}" {% if existing and existing.tipo_manancial == opcao %}selected{% endif %}>{{ opcao }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div>
            <label>
                Possui Curva de Inundação?
                <input type="checkbox" id="possui-curva" class="trigger-condicional" data-target="#curva-inundacao-container"
                        {% if existing and existing.possui_curva %}checked{% endif %}>
            </label>
        </div>

        <div class="campo-condicional" id="curva-inundacao-container">
            <label>Curva de Inundação:
                <select name="curva_inundacao" id="curva_inundacao">
                    <option value="">--Selecione--</option>
                    {% for tipo_curva in curva_inundacao %}
                    <option value="{{ tipo_curva }}">{{ tipo_curva }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div>
            <label>
                Possui Faixa de Servidão?
                <input type="checkbox" id="possui-faixa" class="trigger-condicional" data-target="#faixa-servidao-container"
                        {% if existing and existing.possui_faixa %}checked{% endif %}>
            </label>
        </div>

        <div class="campo-condicional" id="faixa-servidao-container">
            <label>Faixa de Servidão:
                <select name="faixa_servidao" id="faixa_servidao">
                    <option value="">--Selecione--</option>
                             {% for tipo in faixa_servidao %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div>
            <label>
                Possui Diretriz Viária?
                <input type="checkbox" id="possui-diretriz" class="trigger-condicional" data-target="#diretriz-viaria-container"
                        {% if existing and existing.possui_diretriz %}checked{% endif %}>
            </label>
        </div>

        <div class="campo-condicional" id="diretriz-viaria-container">
            <label>Classificação Diretriz Viária:
                <select name="sistema_viario" id="sistema_viario">
                    <option value="">--Selecione--</option>
                    {% for classificacao_metropolitana in sistema_viario %}
                    <option value="{{ classificacao_metropolitana }}">{{ classificacao_metropolitana }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div class="button-group">
            <button type="submit" name="finalizar" value="1">Finalizar</button>
            <button type="reset">Limpar</button>
        </div>

    </form>
</div>

{% if caminho_pdf %}
    <div class="download-pdf-section">
        <h3>PDF Gerado para Protocolo {{ protocolo_pdf }}:</h3>
        <a href="{{ url_for('baixar_pdf') }}" target="_blank" class="btn-download">Download PDF</a>
    </div>
{% endif %}

<script>
$(function () {
    // 1) Inicializa gatilhos (checkboxes) que controlam targets
    $('.trigger-condicional').each(function () {
        var $chk = $(this);
        var target = $chk.data('target');
        if (!target) return;
        $(target).toggle($chk.is(':checked'));
        $chk.on('change', function () {
            $(target).toggle(this.checked);
            if (!this.checked) {
                $(target).find('select, input').val('');
            }
        });
    });

    // 2) Mutual behaviors: quando escolher APA/UTP mostra as zonas correspondentes
    $('#apa').on('change', function () {
        var apa = $(this).val();
        $('#zona-apa-container').toggle(!!apa);
        if (apa) {
            $.getJSON('/get_zonas_apa/' + encodeURIComponent(apa), function (data) {
                var $sel = $('#zona-apa');
                $sel.html('<option value="">--Selecione--</option>');
                $.each(data, function (i, item) {
                    $sel.append($('<option>', { value: item, text: item }));
                });
            });
        } else {
            $('#zona-apa').html('<option value="">--Selecione--</option>');
        }
    }).trigger('change');

    $('#utp').on('change', function () {
        var utp = $(this).val();
        $('#zona-utp-container').toggle(!!utp);
        if (utp) {
            $.getJSON('/get_zonas_utp/' + encodeURIComponent(utp), function (data) {
                var $sel = $('#zona-utp');
                $sel.html('<option value="">--Selecione--</option>');
                $.each(data, function (i, item) {
                    $sel.append($('<option>', { value: item, text: item }));
                });
            });
        } else {
            $('#zona-utp').html('<option value="">--Selecione--</option>');
        }
    }).trigger('change');

    // 3) Município -> macrozonas e zonas urbanas
    $('#municipio').on('change', function () {
        var municipio = $(this).val();
        $('#zona-urbana-container').toggle(!!municipio);
        $('#macrozona-container').toggle(!!municipio);

        if (!municipio) {
            $('#zona-urbana').html('<option value="">--Selecione--</option>');
            $('#macrozona_municipal').html('<option value="">--Selecione--</option>');
            return;
        }

        $.getJSON('/get_zonas_urbanas/' + encodeURIComponent(municipio), function (data) {
            var $sel = $('#zona-urbana');
            $sel.html('<option value="">--Selecione--</option>');
            $.each(data, function (i, item) { $sel.append($('<option>', { value: item, text: item })); });
            $('#zona-urbana-container').show();
        });

        $.getJSON('/get_macrozonas/' + encodeURIComponent(municipio), function (data) {
            var $sel = $('#macrozona_municipal');
            $sel.html('<option value="">--Selecione--</option>');
            $.each(data, function (i, item) { $sel.append($('<option>', { value: item, text: item })); });
            $('#macrozona-container').show();
        });
    }).trigger('change');

    // 4) Localização (mostra blocos se LOCALIZADA)
    $('#situacao_localizacao').on('change', function () {
        $('#localizacao-detalhes').toggle($(this).val() === 'LOCALIZADA');
    }).trigger('change');

    // 5) Tipo de requerente muda visibilidade dos campos
    function toggleCpfCnpj() {
        const tipo = $('#tipo_de_requerente').val();
        if(tipo === 'PESSOA FÍSICA') {
            $('#cpf-container').show();
            $('#cnpj-container').hide();
            $('#cpf-container input').prop('required', true);
            $('#cnpj-container input').prop('required', false).val('');
        } else if(tipo === 'PESSOA JURÍDICA') {
            $('#cnpj-container').show();
            $('#cpf-container').hide();
            $('#cnpj-container input').prop('required', true);
            $('#cpf-container input').prop('required', false).val('');
        } else {
            $('#cpf-container, #cnpj-container').hide();
            $('#cpf-container input, #cnpj-container input').prop('required', false).val('');
        }
    }
    
    $('#tipo_de_requerente').change(toggleCpfCnpj).trigger('change');

    // 6) Adicionar mascara para CPF e CNPJ
    function applyMask(input, mask) {
        input.on('input', function() {
            var value = $(this).val().replace(/\D/g, '');
            var maskedValue = '';
            for (var i = 0, j = 0; i < mask.length && j < value.length; i++) {
                if (mask[i] === '#') {
                    maskedValue += value[j++];
                } else {
                    maskedValue += mask[i];
                }
            }
            $(this).val(maskedValue);
        });
    }

    $('#tipo_de_requerente').on('change', function() {
        if ($(this).val() === 'PESSOA FÍSICA') {
            applyMask($('#cpf-container input'), '###.###.###-##');
        } else if ($(this).val() === 'PESSOA JURÍDICA') {
            applyMask($('#cnpj-container input'), '##.###.###/####-##');
        }
    }).trigger('change');
});
</script>

</body>
</html>